#!/bin/sh
#
#This file is for Multi-Node test
#

MESSAGE_PREFIX="<LAVA_MULTI_NODE>"
MESSAGE_COMMAND="<${LAVA_MULTI_NODE_API}"
MESSAGE_HEAD="$MESSAGE_PREFIX $MESSAGE_COMMAND"
#MESSAGE_ID="<$1>"
MESSAGE_ACK="<${LAVA_MULTI_NODE_API}_ACK>"

MESSAGE_REPLY="<${LAVA_MULTI_NODE_API}_COMPLETE"
MESSAGE_REPLY_ACK="<${LAVA_MULTI_NODE_API}_COMPLETE_ACK>"

_get_key_value_pattern () {
	echo $@|\
	tr ' ' '\n' |\
	sed -n '/\b\w\w*[=]\w\w*\b/p'|\
	tr '\n' ' '
}

_lava_multi_node_debug () {

if [ -n $LAVA_MULTI_NODE_DEBUG ] ; then
	echo "${MESSAGE_COMMAND}_DEBUG $@ $(date)>"
fi

}

_lava_multi_node_send () {

_lava_multi_node_debug "$FUNCNAME started"

result=$(echo $1 | grep "..*=..*")

if [ -n "$1" -a "${result}x" == "x" ] ; then
	echo ${MESSAGE_HEAD} $@">"
else
	_lava_multi_node_debug "$FUNCNAME error messageID : " "$result"
	exit 1
fi

_lava_multi_node_debug "$FUNCNAME finished"

}

_lava_multi_node_print_message () {

#clean old cache file
rm $LAVA_MULTI_NODE_CACHE 2>/dev/null

until [ -z "$1" ] ; do
	result=$(echo $1 | grep "..*=..*")
	if [ "${result}x" != "x" ] ; then
		echo $1 >> $LAVA_MULTI_NODE_CACHE
	fi
	shift
done
}

lava_multi_node_send () {

_lava_multi_node_debug "$FUNCNAME preparing"

_lava_multi_node_send $@

while [ -n "$MESSAGE_NEED_ACK" ] ; do
_lava_multi_node_debug "$FUNCNAME waiting for ack"
	read -t $MESSAGE_TIMEOUT line
	result=$(echo $line | grep "${MESSAGE_ACK}")
	if [ "${result}x" != "x" ] ; then
#		echo ${MESSAGE_ACK}
		break
	fi
	_lava_multi_node_send $@
done

_lava_multi_node_debug "$FUNCNAME finished"

}

lava_multi_node_wait_for_signal () {

_lava_multi_node_debug "$FUNCNAME starting to wait"

while read line; do
	result=$(echo $line | grep "${MESSAGE_REPLY}>")
	if [ "${result}x" != "x" ] ; then
		if [ -n "$MESSAGE_NEED_ACK" ] ; then
			echo ${MESSAGE_REPLY_ACK}
		fi
		break
	fi
done

_lava_multi_node_debug "$FUNCNAME waiting over"

}

lava_multi_node_wait_for_message () {

_lava_multi_node_debug "$FUNCNAME starting to wait"

while read line; do
	result=$(echo $line | grep "${MESSAGE_REPLY}")
	if [ "${result}x" != "x" ] ; then
		line=${line##*${MESSAGE_REPLY}}
		_lava_multi_node_print_message ${line%%>*}
		if [ -n "$MESSAGE_NEED_ACK" ] ; then
			echo ${MESSAGE_REPLY_ACK}
		fi
		break
	fi
done

_lava_multi_node_debug "$FUNCNAME waiting over"

}
