#NOTE the lava_test_shell_action fills in the proper interpreter path
# above during target deployment

# basename is not present on AOSP builds, but the /*\// thing does not
# work with dash (Ubuntu builds) or busybox (OpenEmbedded).  Both of
# those have basename though.
which basename > /dev/null || basename () { echo ${1/*\//}; }

usage () {
    echo "Usage: lava-test--attach FILE [MIME_TYPE]"
    echo ""
    echo "Attach FILE to the current test run."
}

FILE="$1"
shift
MIMETYPE="$1"
shift
if [ $# -gt 0 ]; then
    usage
    exit 1
fi
if [ ! -f "$FILE" ]; then
    usage
    exit 1
fi

# $LAVA_RESULT_DIR is set by lava-test-shell
attachment_dir="$LAVA_RESULT_DIR/attachments"
mkdir -p "attachment_dir"
cp "$FILE" "attachment_dir"
if [ ! -z "$MIMETYPE" ]; then
    echo "$MIMETYPE" > "attachment_dir/$(basename $FILE).mimetype"
fi
